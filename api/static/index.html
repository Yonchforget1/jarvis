<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jarvis</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;height:100vh;display:flex;flex-direction:column}
  #header{padding:12px 20px;background:#111;border-bottom:1px solid #222;display:flex;align-items:center;gap:12px}
  #header h1{font-size:18px;font-weight:600;color:#fff}
  #header .dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
  #messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:720px;padding:12px 16px;border-radius:12px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;font-size:14px}
  .msg.user{background:#1e3a5f;align-self:flex-end;border-bottom-right-radius:4px}
  .msg.assistant{background:#1a1a1a;border:1px solid #2a2a2a;align-self:flex-start;border-bottom-left-radius:4px}
  .msg.system{background:#1a1a0a;border:1px solid #333;align-self:center;font-size:12px;color:#888}
  #input-bar{padding:12px 20px;background:#111;border-top:1px solid #222;display:flex;gap:8px}
  #input-bar textarea{flex:1;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:10px 14px;color:#e0e0e0;font-size:14px;resize:none;outline:none;font-family:inherit;min-height:44px;max-height:120px}
  #input-bar textarea:focus{border-color:#3b82f6}
  #input-bar button{background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:0 20px;cursor:pointer;font-size:14px;font-weight:500}
  #input-bar button:hover{background:#2563eb}
  #input-bar button:disabled{opacity:.5;cursor:not-allowed}
  #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:100}
  .auth-box{background:#111;border:1px solid #333;border-radius:12px;padding:32px;width:340px}
  .auth-box h2{margin-bottom:16px;font-size:20px;color:#fff}
  .auth-box input{width:100%;padding:10px 12px;margin-bottom:12px;background:#1a1a1a;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:14px;outline:none}
  .auth-box input:focus{border-color:#3b82f6}
  .auth-box button{width:100%;padding:10px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500}
  .auth-box button:hover{background:#2563eb}
  .auth-box .toggle{text-align:center;margin-top:12px;font-size:13px;color:#888}
  .auth-box .toggle a{color:#3b82f6;cursor:pointer;text-decoration:none}
  .auth-box .error{color:#ef4444;font-size:13px;margin-bottom:8px;display:none}
</style>
</head>
<body>

<div id="auth-overlay">
  <div class="auth-box">
    <h2 id="auth-title">Login</h2>
    <div id="auth-error" class="error"></div>
    <input id="auth-user" placeholder="Username" autocomplete="username">
    <input id="auth-pass" type="password" placeholder="Password" autocomplete="current-password">
    <input id="auth-email" placeholder="Email (optional)" style="display:none" autocomplete="email">
    <button id="auth-btn" onclick="doAuth()">Login</button>
    <div class="toggle">
      <span id="toggle-text">No account?</span>
      <a id="toggle-link" onclick="toggleAuth()">Register</a>
    </div>
  </div>
</div>

<div id="header">
  <div class="dot"></div>
  <h1>Jarvis</h1>
</div>

<div id="messages"></div>

<div id="input-bar">
  <textarea id="input" placeholder="Message Jarvis..." rows="1" onkeydown="handleKey(event)"></textarea>
  <button id="send-btn" onclick="sendMessage()">Send</button>
</div>

<script>
let token = localStorage.getItem('jarvis_token');
let sessionId = null;
let isRegister = false;

if (token) {
  document.getElementById('auth-overlay').style.display = 'none';
  addMsg('system', 'Connected. Type a message to begin.');
}

function toggleAuth() {
  isRegister = !isRegister;
  document.getElementById('auth-title').textContent = isRegister ? 'Register' : 'Login';
  document.getElementById('auth-btn').textContent = isRegister ? 'Register' : 'Login';
  document.getElementById('auth-email').style.display = isRegister ? 'block' : 'none';
  document.getElementById('toggle-text').textContent = isRegister ? 'Have an account?' : 'No account?';
  document.getElementById('toggle-link').textContent = isRegister ? 'Login' : 'Register';
  document.getElementById('auth-error').style.display = 'none';
}

async function doAuth() {
  const user = document.getElementById('auth-user').value.trim();
  const pass = document.getElementById('auth-pass').value;
  const email = document.getElementById('auth-email').value.trim();
  const errEl = document.getElementById('auth-error');

  if (!user || !pass) { errEl.textContent = 'Username and password required'; errEl.style.display = 'block'; return; }

  const endpoint = isRegister ? '/api/auth/register' : '/api/auth/login';
  const body = isRegister ? { username: user, password: pass, email } : { username: user, password: pass };

  try {
    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.detail || 'Auth failed'; errEl.style.display = 'block'; return; }
    token = data.access_token;
    localStorage.setItem('jarvis_token', token);
    document.getElementById('auth-overlay').style.display = 'none';
    addMsg('system', `Welcome, ${data.username}. Type a message to begin.`);
  } catch (e) {
    errEl.textContent = 'Connection error'; errEl.style.display = 'block';
  }
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  addMsg('user', text);

  const btn = document.getElementById('send-btn');
  btn.disabled = true;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ message: text, session_id: sessionId }),
    });
    const data = await res.json();
    if (!res.ok) {
      if (res.status === 401) { localStorage.removeItem('jarvis_token'); token = null; document.getElementById('auth-overlay').style.display = 'flex'; return; }
      addMsg('system', `Error: ${data.detail || res.statusText}`);
      return;
    }
    sessionId = data.session_id;
    addMsg('assistant', data.response);
  } catch (e) {
    addMsg('system', 'Connection error â€“ is the server running?');
  } finally {
    btn.disabled = false;
    input.focus();
  }
}

// Auto-resize textarea
document.getElementById('input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
</script>
</body>
</html>
