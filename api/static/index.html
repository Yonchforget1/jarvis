<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jarvis</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;height:100vh;display:flex;flex-direction:column}
  #header{padding:12px 20px;background:#111;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between}
  #header .left{display:flex;align-items:center;gap:12px}
  #header h1{font-size:18px;font-weight:600;color:#fff}
  #header .dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
  #header .actions{display:flex;gap:12px}
  #header .actions button{background:none;border:1px solid #333;border-radius:6px;padding:4px 12px;color:#888;font-size:12px;cursor:pointer}
  #header .actions button:hover{border-color:#555;color:#ccc}
  #messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:720px;padding:12px 16px;border-radius:12px;line-height:1.6;word-wrap:break-word;font-size:14px}
  .msg.user{background:#1e3a5f;align-self:flex-end;border-bottom-right-radius:4px;white-space:pre-wrap}
  .msg.assistant{background:#1a1a1a;border:1px solid #2a2a2a;align-self:flex-start;border-bottom-left-radius:4px}
  .msg.system{background:#1a1a0a;border:1px solid #333;align-self:center;font-size:12px;color:#888}
  .msg.assistant p{margin:0 0 8px 0}
  .msg.assistant p:last-child{margin-bottom:0}
  .msg.assistant code{background:#111;padding:2px 5px;border-radius:3px;font-size:13px;font-family:'Cascadia Code','Fira Code',monospace}
  .msg.assistant pre{background:#111;border:1px solid #333;border-radius:6px;padding:12px;margin:8px 0;overflow-x:auto}
  .msg.assistant pre code{background:none;padding:0}
  .msg.assistant ul,.msg.assistant ol{padding-left:20px;margin:8px 0}
  .msg.assistant li{margin:4px 0}
  .msg.assistant h1,.msg.assistant h2,.msg.assistant h3{color:#fff;margin:12px 0 6px 0}
  .msg.assistant blockquote{border-left:3px solid #3b82f6;padding-left:12px;margin:8px 0;color:#999}
  .msg.assistant a{color:#3b82f6;text-decoration:none}
  .msg.assistant a:hover{text-decoration:underline}
  .msg.assistant table{border-collapse:collapse;margin:8px 0}
  .msg.assistant th,.msg.assistant td{border:1px solid #333;padding:6px 10px;text-align:left}
  .msg.assistant th{background:#1a1a1a}
  .thinking{align-self:flex-start;color:#666;font-size:12px}
  .thinking .dots{display:inline-block;animation:pulse 1.5s infinite}
  @keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
  #input-bar{padding:12px 20px;background:#111;border-top:1px solid #222;display:flex;gap:8px}
  #input-bar textarea{flex:1;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:10px 14px;color:#e0e0e0;font-size:14px;resize:none;outline:none;font-family:inherit;min-height:44px;max-height:120px}
  #input-bar textarea:focus{border-color:#3b82f6}
  #input-bar button{background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:0 20px;cursor:pointer;font-size:14px;font-weight:500}
  #input-bar button:hover{background:#2563eb}
  #input-bar button:disabled{opacity:.5;cursor:not-allowed}
  #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:100}
  .auth-box{background:#111;border:1px solid #333;border-radius:12px;padding:32px;width:340px}
  .auth-box h2{margin-bottom:16px;font-size:20px;color:#fff}
  .auth-box input{width:100%;padding:10px 12px;margin-bottom:12px;background:#1a1a1a;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:14px;outline:none}
  .auth-box input:focus{border-color:#3b82f6}
  .auth-box button{width:100%;padding:10px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500}
  .auth-box button:hover{background:#2563eb}
  .auth-box .toggle{text-align:center;margin-top:12px;font-size:13px;color:#888}
  .auth-box .toggle a{color:#3b82f6;cursor:pointer;text-decoration:none}
  .auth-box .error{color:#ef4444;font-size:13px;margin-bottom:8px;display:none}
  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
</style>
</head>
<body>

<div id="auth-overlay">
  <div class="auth-box">
    <h2 id="auth-title">Login</h2>
    <div id="auth-error" class="error"></div>
    <input id="auth-user" placeholder="Username" autocomplete="username">
    <input id="auth-pass" type="password" placeholder="Password" autocomplete="current-password">
    <input id="auth-email" placeholder="Email (optional)" style="display:none" autocomplete="email">
    <button id="auth-btn" onclick="doAuth()">Login</button>
    <div class="toggle">
      <span id="toggle-text">No account?</span>
      <a id="toggle-link" onclick="toggleAuth()">Register</a>
    </div>
  </div>
</div>

<div id="header">
  <div class="left">
    <div class="dot"></div>
    <h1>Jarvis</h1>
  </div>
  <div class="actions">
    <button onclick="newChat()">New Chat</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div id="messages"></div>

<div id="input-bar">
  <textarea id="input" placeholder="Message Jarvis..." rows="1" onkeydown="handleKey(event)"></textarea>
  <button id="send-btn" onclick="sendMessage()">Send</button>
</div>

<script>
marked.setOptions({
  highlight: function(code, lang) {
    if (lang && hljs.getLanguage(lang)) {
      return hljs.highlight(code, { language: lang }).value;
    }
    return hljs.highlightAuto(code).value;
  },
  breaks: true,
});

let token = localStorage.getItem('jarvis_token');
let sessionId = null;
let isRegister = false;

if (token) {
  document.getElementById('auth-overlay').style.display = 'none';
  addMsg('system', 'Connected. Type a message to begin.');
}

function toggleAuth() {
  isRegister = !isRegister;
  document.getElementById('auth-title').textContent = isRegister ? 'Register' : 'Login';
  document.getElementById('auth-btn').textContent = isRegister ? 'Register' : 'Login';
  document.getElementById('auth-email').style.display = isRegister ? 'block' : 'none';
  document.getElementById('toggle-text').textContent = isRegister ? 'Have an account?' : 'No account?';
  document.getElementById('toggle-link').textContent = isRegister ? 'Login' : 'Register';
  document.getElementById('auth-error').style.display = 'none';
}

async function doAuth() {
  const user = document.getElementById('auth-user').value.trim();
  const pass = document.getElementById('auth-pass').value;
  const email = document.getElementById('auth-email').value.trim();
  const errEl = document.getElementById('auth-error');

  if (!user || !pass) { errEl.textContent = 'Username and password required'; errEl.style.display = 'block'; return; }

  const endpoint = isRegister ? '/api/auth/register' : '/api/auth/login';
  const body = isRegister ? { username: user, password: pass, email } : { username: user, password: pass };

  try {
    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.detail || 'Auth failed'; errEl.style.display = 'block'; return; }
    token = data.access_token;
    localStorage.setItem('jarvis_token', token);
    document.getElementById('auth-overlay').style.display = 'none';
    addMsg('system', `Welcome, ${data.username}. Type a message to begin.`);
  } catch (e) {
    errEl.textContent = 'Connection error'; errEl.style.display = 'block';
  }
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if (role === 'assistant') {
    div.innerHTML = marked.parse(text);
    div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
  } else {
    div.textContent = text;
  }
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function showThinking() {
  const div = document.createElement('div');
  div.className = 'thinking';
  div.id = 'thinking';
  div.innerHTML = '<span class="dots">Jarvis is thinking...</span>';
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function hideThinking() {
  const el = document.getElementById('thinking');
  if (el) el.remove();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  addMsg('user', text);
  showThinking();

  const btn = document.getElementById('send-btn');
  btn.disabled = true;

  try {
    const res = await fetch('/api/chat?stream=true', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ message: text, session_id: sessionId }),
    });
    hideThinking();
    if (!res.ok) {
      if (res.status === 401) { localStorage.removeItem('jarvis_token'); token = null; document.getElementById('auth-overlay').style.display = 'flex'; return; }
      const data = await res.json().catch(() => ({}));
      addMsg('system', `Error: ${data.detail || res.statusText}`);
      return;
    }

    // Create assistant message div for streaming
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg assistant';
    document.getElementById('messages').appendChild(msgDiv);
    let fullText = '';

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let eventType = 'message';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            if (eventType === 'meta') { sessionId = data.session_id; }
            else if (eventType === 'done') { fullText = data.full_text; }
            else if (eventType === 'error') { addMsg('system', `Error: ${data.error}`); }
            else if (data.text !== undefined) { fullText += data.text; msgDiv.innerHTML = marked.parse(fullText); }
          } catch {}
          eventType = 'message';
        }
      }
    }
    // Final highlight pass
    msgDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    msgDiv.scrollIntoView({ behavior: 'smooth' });
  } catch (e) {
    hideThinking();
    addMsg('system', 'Connection error â€“ is the server running?');
  } finally {
    btn.disabled = false;
    input.focus();
  }
}

function newChat() {
  sessionId = null;
  document.getElementById('messages').innerHTML = '';
  addMsg('system', 'New session started.');
}

function logout() {
  localStorage.removeItem('jarvis_token');
  token = null;
  sessionId = null;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('auth-overlay').style.display = 'flex';
}

document.getElementById('input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
</script>
</body>
</html>
